<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>
<body>

    <a href="./lancarHora.html">Lançar novo horário</a> <br><br>

    <div id="divBanco">
        <label for="bancoAcumulado">Banco de horas acumulado : </label>
        <p id="bancoAcumulado"></p>

    </div>

    <div id="inputDate">

        <label for="data">Selecione a data para a pesquisa : </label>
    
        <input type="month" name="data" id="data">

    </div>

    <div id="labelResumo">
        <h1 id="textResumo">Relatório de Ponto</h1>
    </div>

    <div id="tabelaContainer"></div>

    <div id="semHora">
        <p id="textSemHora">Sem horários lançados para este mês</p>
    </div>


    <script type="module">

        import { alertas, alertaPageAtual } from './sweetalert.js';

        window.addEventListener('load', async () => {
                alertas();

                const banco = await removerSegundos();

                document.getElementById('bancoAcumulado').innerText = banco;


        });

        function criarTabela(dados) {
            console.log(dados)

            var tabela = `<table style="width:100%"><tr>
            <th>Data</th>
            <th>Entrada</th>
            <th>Saída</th>
            <th>Ida Almoço</th>
            <th>Volta Almoço</th>
            <th>Carga Diária</th>
            <th>Motivo</th>
        </tr>`;

            if (dados.length <= 0) {
                document.getElementById('semHora').setAttribute('style', 'display: flex;');
            } else {
                
                document.getElementById('semHora').setAttribute('style', 'display: none;');

                var linha = ``;

                for (var i = 0; i < dados.length; i ++) {
                    const dataRetorno = new Date(dados[i]['data']);

                    const soData = dataRetorno.toLocaleDateString('pt-BR');

                    linha += `<tr><td><p>${soData}</p></td><td><p>${dados[i]['entrada']}</p></td><td><p>${dados[i]['saida']}</p></td><td><p>${dados[i]['idaIntervalo']}</p></td><td><p>${dados[i]['voltaIntervalo']}</p></td><td><p>${dados[i]['cargaDiaria']}</p></td><td><p>${dados[i]['motivo']}</p></td></tr>
                    `
                }
                tabela = tabela + linha + '</table>';
            }

            return tabela;
        }

        function getCurrentMonthAndYear() {
            const today = new Date();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Janeiro é 0!
            const year = today.getFullYear();
            return `${year}-${month}`;
        }

        const dataAtual = getCurrentMonthAndYear();

        async function puxarHorarios (dataEscolhida) {
            try {        
        
                    const requisicao = await fetch ('http://localhost:3000/usuario/horarios', {
                        method : 'POST',
                        headers : {
                            'Content-Type':'application/json',
                            'Cookies' : decodeURIComponent(document.cookie)
                        },
                        body: JSON.stringify({ dataEscolhida })
                    })
        
                    const resposta = await requisicao.json();


                    return resposta.horarios;                 
    

            } catch (error) {
                console.log(error)
            }
        }

        async function puxarBanco () {
            // Puxar banco de horas

            const requisicao = await fetch('http://localhost:3000/usuario/buscarBanco' , {
                    method : 'POST',
                    headers : {
                        'Cookies' : decodeURIComponent(document.cookie)
                    }
                });

                const resposta = await requisicao.json();

                return resposta['banco'][0]['horasAcumuladas'];
        }

        async function removerSegundos () {
            const horario = await puxarBanco();

            const hora = horario.toString();

            // Divide a string em um array usando ":" como separador
            const partes = hora.split(":");

            // Remove o último elemento do array (os segundos)
            partes.pop();

            if(Number(partes[0]) > 40) {
                return false
            } else {

                // Junta o array novamente usando ":" como separador
                const horaSemSegundos = partes.join(":");
    
                return horaSemSegundos;
            }

        }
        
        // Função para obter a data atual no formato YYYY-MM

        // Definir o valor máximo para o input de mês
        const mesAnoInput = document.getElementById('data');
        mesAnoInput.max = getCurrentMonthAndYear();



        document.getElementById('data').addEventListener('change', async () => {
            const data = document.getElementById('data').value;

            const dados = await puxarHorarios(data);

            const tab = criarTabela(dados);

            document.getElementById('tabelaContainer').innerHTML= tab;
        })
        
    </script>
</body>
</html>