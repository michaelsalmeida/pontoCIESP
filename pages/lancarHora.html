<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>
<body>
    <div>
        <h1>Lançamento de Horas</h1>
    </div>

    <a href="./resumoHoras.html">VOLTAR</a> <br><br>

    <label for="data">DATA : </label>
    <input type="date" name="data" id="data" required> <br><br>

    <label for="horaEntrada">ENTRADA : </label>
    <input type="time" name="horaEntrada" id="horaEntrada" required>

    <label for="horaSaida">SAIDA : </label>
    <input type="time" name="horaSaida" id="horaSaida" required>

    <label for="idaAlmoco">IDA ALMOÇO : </label>
    <input type="time" name="idaAlmoco" id="idaAlmoco" required>

    <label for="voltaAlmoco">VOLTA ALMOÇO : </label>
    <input type="time" name="voltaAlmoco" id="voltaAlmoco" required> <br><br>

    <label for="motivo">MOTIVO : </label>
    <input type="text" name="motivo" id="motivo" value="Jornada normal" required><br><br>

    <button id="lancarHora">LANÇAR HORA</button> <br><br>

    <button id="somatoriaHoras">SOMAR</button>

    <script type="module">
        import { alertas, alertaPageAtual } from './sweetalert.js';

        window.addEventListener('load', async () => {
            alertas();
        })

        document.getElementById('somatoriaHoras').addEventListener('click', () => {
            somarHorarios('17:30', '03:45');
        })

        async function puxarBanco () {
            // Puxar banco de horas

            const requisicao = await fetch('http://localhost:3000/usuario/buscarBanco' , {
                    method : 'POST',
                    headers : {
                        'Cookies' : decodeURIComponent(document.cookie)
                    }
                });

                const resposta = await requisicao.json();

                return resposta['banco'][0]['horasAcumuladas'];
        }

        async function calcularDiferencaHorarios(horaInicial, horaFinal) {
            // Divide as strings de hora em horas e minutos
            const [horaInicialH, horaInicialM] = horaInicial.split(':').map(Number);
            const [horaFinalH, horaFinalM] = horaFinal.split(':').map(Number);

            // Cria objetos Date para os horários inicial e final
            const dataInicial = new Date();
            dataInicial.setHours(horaInicialH, horaInicialM, 0, 0);
            const dataFinal = new Date();
            dataFinal.setHours(horaFinalH, horaFinalM, 0, 0);

            // Calcula a diferença em milissegundos
            const diferencaEmMilissegundos = dataFinal - dataInicial;

            // Converte a diferença para horas
            const diferencaEmHoras = diferencaEmMilissegundos / (1000 * 60 * 60);

            // Formata a diferença em horas para HH:MM
            const horas = Math.floor(diferencaEmHoras);
            const minutos = Math.floor((diferencaEmHoras - horas) * 60);
            const resultado = `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;

            return resultado;
        }

        async function somarHorarios(hora1, hora2) {
            // Separa as horas e minutos de cada horário
            const [horas1, minutos1] = hora1.split(':').map(Number);
            const [horas2, minutos2] = hora2.split(':').map(Number);

            // Calcula a soma dos minutos
            var minutosTotal = minutos1 + minutos2;
            var horasAdicionais = 0;

            // Se a soma dos minutos for maior que 60, adiciona uma hora e ajusta os minutos
            if (minutosTotal >= 60) {
                horasAdicionais = Math.floor(minutosTotal / 60);
                minutosTotal %= 60;
            }

            // Calcula a soma das horas
            var horasTotal = horas1 + horas2 + horasAdicionais;

            if(horasTotal >= 40) {
            
                return `40:00`;
            } else {
                // Formata o resultado para o formato HH:MM
                let horasFormatadas = horasTotal.toString().padStart(2, '0');
                let minutosFormatados = minutosTotal.toString().padStart(2, '0');
    
                return `${horasFormatadas}:${minutosFormatados}`;

            }

        }

        // Calcula quanto do horário do almoço faltou completar
        function tempoRestante(horarioUsuario) {
            // Separa as horas e minutos do horário do usuário
            const [horasUsuario, minutosUsuario] = horarioUsuario.split(':').map(Number);

            // Define o horário alvo (1:30)
            const horasAlvo = 1;
            const minutosAlvo = 30;

            // Calcula a diferença em minutos
            let diferencaMinutos = (horasAlvo * 60 + minutosAlvo) - (horasUsuario * 60 + minutosUsuario);

            // Se a diferença for negativa, significa que o horário alvo já passou
            if (diferencaMinutos < 0) {
                diferencaMinutos += 24 * 60; // Adiciona 24 horas (1440 minutos)
            }

            // Calcula horas e minutos restantes
            const horasRestantes = Math.floor(diferencaMinutos / 60);
            const minutosRestantes = diferencaMinutos % 60;

            // Formata a saída
            return `${horasRestantes}:${minutosRestantes.toString().padStart(2, '0')}`;
            }
        
        
        async function lancarHoras () {
            const data = document.getElementById('data').value;
            const entrada = document.getElementById('horaEntrada').value;
            const saida = document.getElementById('horaSaida').value;
            const idaAlmoco = document.getElementById('idaAlmoco').value;
            const voltaAlmoco = document.getElementById('voltaAlmoco').value;
            const motivo = document.getElementById('motivo').value;
            
            // flags para saber se vai ter banco de horas para adicionar ao banco

            // flag para saber se a pessoa passou das 9 horas trabalhadas no dia
            var passouHorarioNormal = false;

            // flag para saber se a pessoa realizou menos de 1:30 de almoço obrigatório
            var faltouHorarioAlmoco = false;

            // carga horária em string
            const cargaDiaria = await calcularDiferencaHorarios(entrada, saida);

            // calcular horário de almoço.

            const tempoFeitoHorarioAlmoco = await calcularDiferencaHorarios(idaAlmoco, voltaAlmoco);

            // tempo para saber se faltou para completar o horário de almoço e adicionar no banco
            const tempoFaltanteParaCompletarHoraAlmoco = await tempoRestante(tempoFeitoHorarioAlmoco);

            // separando as horas dos minutos e transformando cada um em number
            const [horas, minutos] = cargaDiaria.split(':').map(Number);
        

            if(horas > 9 || (horas === 9 && minutos > 0)) {            
                passouHorarioNormal = true;

            }

            if (tempoFaltanteParaCompletarHoraAlmoco < '1:30') {
                faltouHorarioAlmoco = true;
            }

            if (data != '' && entrada != '' && saida != '' && idaAlmoco != '' && voltaAlmoco != '' && motivo != '') {
                const dadosEnviados = {
                    data,
                    entrada,
                    saida,
                    idaAlmoco,
                    voltaAlmoco,
                    cargaDiaria,
                    motivo
                }
                
                const requisicao = await fetch ('http://localhost:3000/usuario/lancarHora', {
                    method : 'POST',
                    credentials : 'include',
                    headers : {
                        'Content-Type' : 'application/json',
                        'Cookies' : decodeURIComponent(document.cookie)
                    },
                    body : JSON.stringify(dadosEnviados)
                });
    
                const resposta = await requisicao.json();

                if (passouHorarioNormal) {
                    // Pega as horas escedidas na carga horária.
                    const horaAmais = `${horas - 9}:${minutos}`;


                    // Pega a quantidade de horas já acumuladas no banco de dados
                    const bancoAtual = await removerSegundos();  

                    // Verifica se as horas acumuladas no banco já estão no limide e 40
                    if(bancoAtual != false) {
                        const horaParaBanco = await somarHorarios(bancoAtual, horaAmais);

                        const requisicao = await fetch ('http://localhost:3000/usuario/lancarBanco', {
                            method: 'POST',
                            headers : {
                                'Content-Type' : 'application/json',
                                'Cookies' : decodeURIComponent(document.cookie)
                            },
                            body : JSON.stringify({ horaParaBanco })
                        })
                        
                    }
                } 
                
                if (faltouHorarioAlmoco) {
                    // Pega a quantidade de horas já acumuladas no banco de dados
                    const bancoAtual = await removerSegundos(); 

                    // Verifica se as horas acumuladas no banco já estão no limide e 40
                    if(bancoAtual != false) {
                        const horaParaBanco = await somarHorarios(bancoAtual, tempoFaltanteParaCompletarHoraAlmoco);

                        const requisicao = await fetch ('http://localhost:3000/usuario/lancarBanco', {
                            method: 'POST',
                            headers : {
                                'Content-Type' : 'application/json',
                                'Cookies' : decodeURIComponent(document.cookie)
                            },
                            body : JSON.stringify({ horaParaBanco })
                        })
                        
                    }
                }
    
                sessionStorage.setItem('status', resposta.status);
                sessionStorage.setItem('mensagem', resposta.msg);
    
                if (resposta.status == 'success') {
                    window.location.href = './resumoHoras.html';
                } else {
                    alertas();
                }
                     
            } else {
                alertaPageAtual('error', 'Preencha todos os campos')
            }

        } 

        async function removerSegundos () {
            const horario = await puxarBanco();

            const hora = horario.toString();

            // Divide a string em um array usando ":" como separador
            const partes = hora.split(":");

            // Remove o último elemento do array (os segundos)
            partes.pop();

            if(Number(partes[0]) > 40) {
                return false
            } else {

                // Junta o array novamente usando ":" como separador
                const horaSemSegundos = partes.join(":");
    
                return horaSemSegundos;
            }

        }

        document.getElementById('lancarHora').addEventListener('click', () => {
            lancarHoras();
        })
    </script>
    
</body>
</html>